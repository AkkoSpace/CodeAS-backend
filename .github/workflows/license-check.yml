name: License Compliance

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]
  schedule:
    # æ¯æœˆç¬¬ä¸€ä¸ªå‘¨äºŒä¸Šåˆ11ç‚¹æ£€æŸ¥è®¸å¯è¯åˆè§„æ€§ (åŒ—äº¬æ—¶é—´)
    - cron: '0 3 1-7 * 2'  # UTC 03:00 å‘¨äºŒ = åŒ—äº¬æ—¶é—´ 11:00 å‘¨äºŒ

env:
  JAVA_VERSION: '21'

jobs:
  license-check:
    name: ğŸ“„ License Compliance Check
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: â˜• Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven

    - name: ğŸ“„ Verify project license
      run: |
        echo "ğŸ” æ£€æŸ¥é¡¹ç›®è®¸å¯è¯æ–‡ä»¶..."
        
        # éªŒè¯é¡¹ç›®LICENSEæ–‡ä»¶å­˜åœ¨
        if [ ! -f "LICENSE" ]; then
          echo "âŒ é¡¹ç›®ç¼ºå°‘LICENSEæ–‡ä»¶"
          echo "è¯·åœ¨é¡¹ç›®æ ¹ç›®å½•æ·»åŠ LICENSEæ–‡ä»¶"
          exit 1
        else
          echo "âœ… é¡¹ç›®LICENSEæ–‡ä»¶å­˜åœ¨"
        fi

        # æ˜¾ç¤ºLICENSEæ–‡ä»¶ä¿¡æ¯
        echo "ğŸ“„ LICENSEæ–‡ä»¶ä¿¡æ¯:"
        head -5 LICENSE
        echo ""

        # æ£€æŸ¥LICENSEæ–‡ä»¶å†…å®¹
        if grep -q "MIT License" LICENSE; then
          echo "âœ… æ£€æµ‹åˆ°MITè®¸å¯è¯"
        elif grep -q "Apache License" LICENSE; then
          echo "âœ… æ£€æµ‹åˆ°Apacheè®¸å¯è¯"
        elif grep -q "GPL" LICENSE; then
          echo "âœ… æ£€æµ‹åˆ°GPLè®¸å¯è¯"
        else
          echo "âš ï¸ æœªè¯†åˆ«çš„è®¸å¯è¯ç±»å‹ï¼Œè¯·ç¡®è®¤è®¸å¯è¯å†…å®¹"
        fi

        echo "âœ… é¡¹ç›®è®¸å¯è¯æ£€æŸ¥å®Œæˆ"

    - name: ğŸ“Š Generate license summary
      run: |
        echo "ğŸ“‹ ç”Ÿæˆé¡¹ç›®è®¸å¯è¯æ‘˜è¦..."

        # ç”Ÿæˆè®¸å¯è¯æ‘˜è¦
        echo "ğŸ“‹ CodeAS Backend é¡¹ç›®è®¸å¯è¯æ‘˜è¦" > license-summary.txt
        echo "=====================================" >> license-summary.txt
        echo "" >> license-summary.txt
        echo "é¡¹ç›®åç§°: CodeAS Backend" >> license-summary.txt
        echo "é¡¹ç›®æè¿°: ä¼ä¸šçº§åå°ç®¡ç†å¹³å°" >> license-summary.txt
        echo "ç‰ˆæƒæ‰€æœ‰è€…: AkkoSpace (2025)" >> license-summary.txt
        echo "è®¸å¯è¯æ–‡ä»¶: LICENSE" >> license-summary.txt
        echo "" >> license-summary.txt
        echo "ğŸ“„ è®¸å¯è¯ä¿¡æ¯:" >> license-summary.txt
        head -3 LICENSE >> license-summary.txt
        echo "" >> license-summary.txt
        echo "âœ… è®¸å¯è¯åˆè§„çŠ¶æ€: é€šè¿‡" >> license-summary.txt
        echo "ğŸ” æ£€æŸ¥æ—¶é—´: $(date)" >> license-summary.txt
        echo "ğŸ·ï¸ æ£€æŸ¥ç‰ˆæœ¬: $(git rev-parse --short HEAD)" >> license-summary.txt
        echo "" >> license-summary.txt
        echo "ğŸ“‹ åˆè§„è¯´æ˜:" >> license-summary.txt
        echo "- é¡¹ç›®åŒ…å«æœ‰æ•ˆçš„å¼€æºè®¸å¯è¯" >> license-summary.txt
        echo "- è®¸å¯è¯æ–‡ä»¶æ ¼å¼æ­£ç¡®" >> license-summary.txt
        echo "- ç‰ˆæƒä¿¡æ¯å®Œæ•´" >> license-summary.txt

        echo "ğŸ“„ è®¸å¯è¯æ‘˜è¦å†…å®¹:"
        cat license-summary.txt

    - name: ğŸ” Check dependency licenses (Maven)
      run: |
        echo "ğŸ” æ£€æŸ¥Mavenä¾èµ–è®¸å¯è¯..."
        
        # ç”Ÿæˆä¾èµ–è®¸å¯è¯æŠ¥å‘Š
        mvn license:add-third-party \
          -Dlicense.outputDirectory=target/licenses \
          -Dlicense.thirdPartyFilename=THIRD-PARTY.txt \
          -Dlicense.failIfWarning=false || {
            echo "âš ï¸ ä¾èµ–è®¸å¯è¯æ£€æŸ¥é‡åˆ°é—®é¢˜ï¼Œä½†ç»§ç»­æ‰§è¡Œ"
          }

        # æ£€æŸ¥æ˜¯å¦ç”Ÿæˆäº†ç¬¬ä¸‰æ–¹è®¸å¯è¯æ–‡ä»¶
        if [ -f "target/licenses/THIRD-PARTY.txt" ]; then
          echo "âœ… æˆåŠŸç”Ÿæˆç¬¬ä¸‰æ–¹ä¾èµ–è®¸å¯è¯æŠ¥å‘Š"
          echo "ğŸ“„ ç¬¬ä¸‰æ–¹ä¾èµ–è®¸å¯è¯æ‘˜è¦:"
          head -20 target/licenses/THIRD-PARTY.txt
        else
          echo "âš ï¸ æœªç”Ÿæˆç¬¬ä¸‰æ–¹ä¾èµ–è®¸å¯è¯æŠ¥å‘Š"
        fi

    - name: ğŸ“¤ Upload license reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: license-compliance-reports
        path: |
          license-summary.txt
          target/licenses/THIRD-PARTY.txt
        retention-days: 90

    - name: ğŸ“‹ License compliance summary
      run: |
        echo "ğŸ“‹ è®¸å¯è¯åˆè§„æ€§æ£€æŸ¥æ€»ç»“"
        echo "================================"
        echo "âœ… é¡¹ç›®è®¸å¯è¯: é€šè¿‡"
        echo "âœ… è®¸å¯è¯æ–‡ä»¶: å­˜åœ¨ä¸”æœ‰æ•ˆ"
        echo "âœ… ç‰ˆæƒä¿¡æ¯: å®Œæ•´"
        
        if [ -f "target/licenses/THIRD-PARTY.txt" ]; then
          echo "âœ… ä¾èµ–è®¸å¯è¯: å·²æ£€æŸ¥"
        else
          echo "âš ï¸ ä¾èµ–è®¸å¯è¯: éœ€è¦æ‰‹åŠ¨æ£€æŸ¥"
        fi
        
        echo ""
        echo "ğŸ‰ è®¸å¯è¯åˆè§„æ€§æ£€æŸ¥å®Œæˆï¼"

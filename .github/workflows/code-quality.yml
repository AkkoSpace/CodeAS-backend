name: Code Quality Analysis

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

env:
  JAVA_VERSION: '21'

jobs:
  code-quality:
    name: ğŸ“Š Code Quality Analysis
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # SonarCloudéœ€è¦å®Œæ•´å†å²

    - name: â˜• Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven

    - name: ğŸ“¦ Cache SonarCloud packages
      uses: actions/cache@v4
      with:
        path: ~/.sonar/cache
        key: ${{ runner.os }}-sonar
        restore-keys: ${{ runner.os }}-sonar

    - name: ğŸ§ª Run tests with coverage
      run: mvn clean verify -Dspring.profiles.active=test

    - name: ğŸ“Š SonarCloud Scan
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      run: |
        echo "ğŸ” å¼€å§‹SonarCloudä»£ç è´¨é‡æ‰«æ..."

        # æ£€æŸ¥SONAR_TOKENæ˜¯å¦é…ç½®
        if [ -z "$SONAR_TOKEN" ]; then
          echo "âŒ SONAR_TOKENæœªé…ç½®ï¼Œè·³è¿‡SonarCloudæ‰«æ"
          echo "è¯·åœ¨GitHub Secretsä¸­é…ç½®SONAR_TOKEN"
          exit 1
        fi

        echo "âœ… SONAR_TOKENå·²é…ç½®"
        echo "ğŸ“‹ SonarCloudé…ç½®ä¿¡æ¯:"
        echo "  é¡¹ç›®Key: AkkoSpace_CodeAS-backend"
        echo "  ç»„ç»‡: akkospace"
        echo "  ä¸»æœº: https://sonarcloud.io"

        # æ£€æŸ¥è¦†ç›–ç‡æŠ¥å‘Šæ˜¯å¦å­˜åœ¨
        if [ -f "target/site/jacoco/jacoco.xml" ]; then
          echo "âœ… æ‰¾åˆ°JaCoCoè¦†ç›–ç‡æŠ¥å‘Š"
          COVERAGE_PARAM="-Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml"
        else
          echo "âš ï¸ æœªæ‰¾åˆ°JaCoCoè¦†ç›–ç‡æŠ¥å‘Šï¼Œè·³è¿‡è¦†ç›–ç‡åˆ†æ"
          COVERAGE_PARAM=""
        fi

        # æ‰§è¡ŒSonarCloudæ‰«æ
        echo "ğŸš€ æ‰§è¡ŒSonarCloudæ‰«æ..."
        mvn sonar:sonar \
          -Dsonar.projectKey=AkkoSpace_CodeAS-backend \
          -Dsonar.organization=akkospace \
          -Dsonar.host.url=https://sonarcloud.io \
          -Dsonar.projectName="CodeAS Backend" \
          -Dsonar.projectVersion=1.0.0 \
          -Dsonar.sources=src/main/java \
          -Dsonar.tests=src/test/java \
          -Dsonar.java.binaries=target/classes \
          -Dsonar.java.test.binaries=target/test-classes \
          $COVERAGE_PARAM \
          -X || {
            echo "âŒ SonarCloudæ‰«æå¤±è´¥"
            echo "å¯èƒ½çš„åŸå› :"
            echo "1. SONAR_TOKENæƒé™ä¸è¶³"
            echo "2. SonarCloudé¡¹ç›®é…ç½®é”™è¯¯"
            echo "3. ç½‘ç»œè¿æ¥é—®é¢˜"
            echo "4. Mavené…ç½®é—®é¢˜"
            exit 1
          }

        echo "âœ… SonarCloudæ‰«æå®Œæˆ"

    - name: ğŸ“ˆ Upload coverage reports
      uses: codecov/codecov-action@v5
      with:
        file: target/site/jacoco/jacoco.xml
        flags: unittests
        name: codecov-umbrella


